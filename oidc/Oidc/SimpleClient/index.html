<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>SimpleClient (oidc.Oidc.SimpleClient)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">oidc</a> &#x00BB; <a href="../index.html">Oidc</a> &#x00BB; SimpleClient</nav><header class="odoc-preamble"><h1>Module <code><span>Oidc.SimpleClient</span></code></h1><p>Simpler interface for creating a oidc client</p></header><nav class="odoc-toc"><ul><li><a href="#uri-builders">URI builders</a></li><li><a href="#request-builders">Request builders</a></li><li><a href="#example---google">Example - Google</a><ul><li><a href="#server-start">Server start</a></li><li><a href="#authenitcation-route">Authenitcation route</a></li><li><a href="#callback-route">Callback route</a></li></ul></li></ul></nav><div class="odoc-content"><div class="odoc-spec"><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span><span> = </span><span>{</span></code><table><tr id="type-t.client" class="anchored"><td class="def record field"><a href="#type-t.client" class="anchor"></a><code><span>client : <a href="../Client/index.html#type-t">Client.t</a>;</span></code></td></tr><tr id="type-t.provider_uri" class="anchored"><td class="def record field"><a href="#type-t.provider_uri" class="anchor"></a><code><span>provider_uri : <span class="xref-unresolved">Uri</span>.t;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>The uri where we'll find the provider</p><span class="comment-delim">*)</span></td></tr><tr id="type-t.redirect_uri" class="anchored"><td class="def record field"><a href="#type-t.redirect_uri" class="anchor"></a><code><span>redirect_uri : <span class="xref-unresolved">Uri</span>.t;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>The uri where the provider should return the user</p><span class="comment-delim">*)</span></td></tr></table><code><span>}</span></code></div><div class="spec-doc"><p>Client with information needed to create calls</p></div></div><div class="odoc-spec"><div class="spec value" id="val-make" class="anchored"><a href="#val-make" class="anchor"></a><code><span><span class="keyword">val</span> make : 
  <span>?secret:string <span class="arrow">&#45;&gt;</span></span>
  <span>?response_types:<span>string list</span> <span class="arrow">&#45;&gt;</span></span>
  <span>?grant_types:<span>string list</span> <span class="arrow">&#45;&gt;</span></span>
  <span>?token_endpoint_auth_method:string <span class="arrow">&#45;&gt;</span></span>
  <span>redirect_uri:<span class="xref-unresolved">Uri</span>.t <span class="arrow">&#45;&gt;</span></span>
  <span>provider_uri:<span class="xref-unresolved">Uri</span>.t <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p>Create a simple client, it creates a <a href="../Client/index.html#type-t">oidc client</a> with some optional defaults.</p><p>Defaults:</p><ul><li><code>response_types</code> - <code>[&quot;code&quot;]</code></li><li><code>grant_types</code> - <code>[]</code></li><li><code>token_endpoint_auth_method</code> - <code>[&quot;client_secret_post&quot;]</code></li></ul></div></div><h3 id="uri-builders"><a href="#uri-builders" class="anchor"></a>URI builders</h3><div class="odoc-spec"><div class="spec value" id="val-discovery_uri" class="anchored"><a href="#val-discovery_uri" class="anchor"></a><code><span><span class="keyword">val</span> discovery_uri : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Uri</span>.t</span></code></div><div class="spec-doc"><p>Get the discovery_uri as specified in the <a href="https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfig">OIDC spec</a></p></div></div><div class="odoc-spec"><div class="spec value" id="val-make_auth_uri" class="anchored"><a href="#val-make_auth_uri" class="anchor"></a><code><span><span class="keyword">val</span> make_auth_uri : 
  <span>?scope:<span>string list</span> <span class="arrow">&#45;&gt;</span></span>
  <span>?claims:<span class="xref-unresolved">Yojson</span>.Safe.t <span class="arrow">&#45;&gt;</span></span>
  <span>?nonce:string <span class="arrow">&#45;&gt;</span></span>
  <span>state:string <span class="arrow">&#45;&gt;</span></span>
  <span>discovery:<a href="../Discover/index.html#type-t">Discover.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Uri</span>.t</span></code></div><div class="spec-doc"><p>Builds the uri used for redirecting the user to the provider</p><ul><li><code>scope</code> example input: <code>[&quot;openid&quot;; &quot;email&quot;; &quot;profile&quot;]</code></li><li><code>nonce</code> should be validated when the user comes back to make sure they were not hijacked</li><li><code>state</code> will be returend by the provider and can be used to remember where to redirect the user after successful login</li></ul></div></div><h3 id="request-builders"><a href="#request-builders" class="anchor"></a>Request builders</h3><div class="odoc-spec"><div class="spec type" id="type-meth" class="anchored"><a href="#type-meth" class="anchor"></a><code><span><span class="keyword">type</span> meth</span><span> = </span><span>[ </span></code><table><tr id="type-meth.POST" class="anchored"><td class="def constructor"><a href="#type-meth.POST" class="anchor"></a><code><span>| </span></code><code><span>`POST</span></code></td></tr><tr id="type-meth.GET" class="anchored"><td class="def constructor"><a href="#type-meth.GET" class="anchor"></a><code><span>| </span></code><code><span>`GET</span></code></td></tr><tr id="type-meth.CONNECT" class="anchored"><td class="def constructor"><a href="#type-meth.CONNECT" class="anchor"></a><code><span>| </span></code><code><span>`CONNECT</span></code></td></tr><tr id="type-meth.DELETE" class="anchored"><td class="def constructor"><a href="#type-meth.DELETE" class="anchor"></a><code><span>| </span></code><code><span>`DELETE</span></code></td></tr><tr id="type-meth.HEAD" class="anchored"><td class="def constructor"><a href="#type-meth.HEAD" class="anchor"></a><code><span>| </span></code><code><span>`HEAD</span></code></td></tr><tr id="type-meth.PUT" class="anchored"><td class="def constructor"><a href="#type-meth.PUT" class="anchor"></a><code><span>| </span></code><code><span>`PUT</span></code></td></tr><tr id="type-meth.TRACE" class="anchored"><td class="def constructor"><a href="#type-meth.TRACE" class="anchor"></a><code><span>| </span></code><code><span>`TRACE</span></code></td></tr><tr id="type-meth.OPTIONS" class="anchored"><td class="def constructor"><a href="#type-meth.OPTIONS" class="anchor"></a><code><span>| </span></code><code><span>`OPTIONS</span></code></td></tr><tr id="type-meth.Other" class="anchored"><td class="def constructor"><a href="#type-meth.Other" class="anchor"></a><code><span>| </span></code><code><span>`Other <span class="keyword">of</span> string</span></code></td></tr></table><code><span> ]</span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-request_descr" class="anchored"><a href="#type-request_descr" class="anchor"></a><code><span><span class="keyword">type</span> request_descr</span><span> = </span><span>{</span></code><table><tr id="type-request_descr.body" class="anchored"><td class="def record field"><a href="#type-request_descr.body" class="anchor"></a><code><span>body : <span>string option</span>;</span></code></td></tr><tr id="type-request_descr.headers" class="anchored"><td class="def record field"><a href="#type-request_descr.headers" class="anchor"></a><code><span>headers : <span><span>(string * string)</span> list</span>;</span></code></td></tr><tr id="type-request_descr.uri" class="anchored"><td class="def record field"><a href="#type-request_descr.uri" class="anchor"></a><code><span>uri : <span class="xref-unresolved">Uri</span>.t;</span></code></td></tr><tr id="type-request_descr.meth" class="anchored"><td class="def record field"><a href="#type-request_descr.meth" class="anchor"></a><code><span>meth : <a href="#type-meth">meth</a>;</span></code></td></tr></table><code><span>}</span></code></div><div class="spec-doc"><p>Request description that can be used by a http client to make the needed call</p></div></div><div class="odoc-spec"><div class="spec value" id="val-make_token_request" class="anchored"><a href="#val-make_token_request" class="anchor"></a><code><span><span class="keyword">val</span> make_token_request : 
  <span>code:string <span class="arrow">&#45;&gt;</span></span>
  <span>discovery:<a href="../Discover/index.html#type-t">Discover.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-request_descr">request_descr</a></span></code></div><div class="spec-doc"><p>Creates a <a href="#type-request_descr"><code>request_descr</code></a> for the token request</p></div></div><div class="odoc-spec"><div class="spec value" id="val-make_userinfo_request" class="anchored"><a href="#val-make_userinfo_request" class="anchor"></a><code><span><span class="keyword">val</span> make_userinfo_request : 
  <span>token:<a href="../Token/Response/index.html#type-t">Token.Response.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>discovery:<a href="../Discover/index.html#type-t">Discover.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>( <a href="#type-request_descr">request_descr</a>, <span>[&gt; <a href="../Error/index.html#type-t">Error.t</a> ]</span> )</span> <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div><div class="spec-doc"><p>Creates a <a href="#type-request_descr"><code>request_descr</code></a> for the userinfo request</p></div></div><div class="odoc-spec"><div class="spec value" id="val-valid_token_of_string" class="anchored"><a href="#val-valid_token_of_string" class="anchor"></a><code><span><span class="keyword">val</span> valid_token_of_string : 
  <span>?clock_tolerance:int <span class="arrow">&#45;&gt;</span></span>
  <span>jwks:<span class="xref-unresolved">Jose</span>.Jwks.t <span class="arrow">&#45;&gt;</span></span>
  <span>discovery:<a href="../Discover/index.html#type-t">Discover.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span>( <a href="../Token/Response/index.html#type-t">Token.Response.t</a>, <span>[&gt; <a href="../IDToken/index.html#type-validation_error">IDToken.validation_error</a> ]</span> )</span> <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div><div class="spec-doc"><p>Will parse the string and validate the token</p><p><code>clock_tolerance</code> is used to allow a difference between the providers and clients clock</p></div></div><div class="odoc-spec"><div class="spec value" id="val-valid_userinfo_of_string" class="anchored"><a href="#val-valid_userinfo_of_string" class="anchor"></a><code><span><span class="keyword">val</span> valid_userinfo_of_string : 
  <span>token_response:<a href="../Token/Response/index.html#type-t">Token.Response.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span>( string, <span>[&gt; `Missing_sub <span>| `Sub_missmatch</span> <span><span>| `Msg</span> of string</span> ]</span> )</span> <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div></div><h3 id="example---google"><a href="#example---google" class="anchor"></a>Example - Google</h3><p>This example is written as if your http client is synchronos since we don't have a <code>Lwt</code> or <code>Async</code> dependency in the core. For a more complete example look in the <code>executable</code> folder.</p><h4 id="server-start"><a href="#server-start" class="anchor"></a>Server start</h4><p>We have to do some things when the server starts to prepare</p><pre><code>let secret = Sys.getenv &quot;OIDC_SECRET&quot;
let client_id = Sys.getenv &quot;OIDC_CLIENT_ID&quot;
let provider_uri = Uri.of_string &quot;https://accounts.google.com&quot;
let redirect_uri = Uri.of_string &quot;http://localhost:8080/auth/callback&quot;

(* Create a client, it will create a oidc client
   under the hood and inherits parameters from there *)
let simple_client = Oidc.SimpleClient.make ~redirect_uri ~provider_uri ~secret client_id

let discovery =
  let uri = Oidc.SimpleClient.discovery_uri simple_client in
  let discovery_string = HttpClient.get uri in
  Oidc.Discover.of_string discovery_string

let jwks =
  let uri = discovery.jwks_uri in
  let jwks_string = HttpClient.get uri in
  Jose.Jwks.of_string jwks_string</code></pre><h4 id="authenitcation-route"><a href="#authenitcation-route" class="anchor"></a>Authenitcation route</h4><p>When the user is supposed to login you create the URI and redirect the user to the provider.</p><pre><code>let uri = Oidc.SimpleClient.make_auth_uri ~scope:[&quot;openid&quot;; &quot;email&quot;; &quot;profile&quot;] ~state:&quot;state&quot; ~discovery client in
HttpServer.redirect uri</code></pre><h4 id="callback-route"><a href="#callback-route" class="anchor"></a>Callback route</h4><p>When the user returns from the provider we have to fetch the tokens and do some validation and (optionally) get the userinfo.</p><pre><code>let code = HttpServer.get_query &quot;code&quot; request in
let state = HttpServer.get_query &quot;state&quot; request in

let token_response =
  (* Get a request_descr *)
  let token_request = Oidc.SimpleClient.make_token_request ~code ~discovery client in
  HttpClient.request token_request
  |&gt; Oidc.SimpleClient.valid_token_of_string ~jwks ~discovery client in
in

(* You don't need to get the userinfo, but it can be useful since the id_token doesn't have to include all the information *)
let userinfo =
  (* Get a request_descr *)
  let userinfo_request = Oidc.SimpleClient.make_userinfo_request ~token:validated_token ~discovery in
  HttpClient.request userinfo_request
  |&gt; Oidc.Userinfo.validate ~jwt:token_response_id_token
in

match (validated_token, userinfo) with
| Ok tokens, Ok userinfo -&gt;
  let id_token = tokens.id_token in
  (* Theoretically we're not sure we'll have a access_token... *)
  let access_token =
    Option.value ~default:&quot;no access_token&quot; tokens.access_token
  in
  (* Same as access_token *)
  let refresh_token =
    Option.value ~default:&quot;no refresh_token&quot; tokens.refresh_token
  in
  
  (* Save the values in session for later retrieval *)
  let () = HttpServer.put_session &quot;id_token&quot; id_token request in
  let () = HttpServer.put_session &quot;access_token&quot; access_token request in
  let () = HttpServer.put_session &quot;refresh_token&quot; refresh_token request in
  let () = HttpServer.put_session &quot;userinfo&quot; userinfo request in
  
  HttServer.respond id_token
| Error e -&gt; HttpServer.respond @@ Oidc.Error.to_string e</code></pre></div></body></html>